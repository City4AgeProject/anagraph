package eu.city4age.dashboard.api.pojo.domain;

import java.math.BigDecimal;
import java.util.HashSet;
import java.util.Set;

import javax.persistence.Column;
import javax.persistence.ColumnResult;
import javax.persistence.ConstructorResult;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;
import javax.persistence.SqlResultSetMapping;
import javax.persistence.SqlResultSetMappings;
import javax.persistence.Table;

import org.hibernate.annotations.NamedNativeQueries;
import org.hibernate.annotations.NamedNativeQuery;

import com.fasterxml.jackson.annotation.JsonView;

import eu.city4age.dashboard.api.pojo.dto.Nuis;
import eu.city4age.dashboard.api.pojo.json.view.View;

@SqlResultSetMappings(value = { @SqlResultSetMapping(name = "avgMapping", columns = { @ColumnResult(name = "avg") }),
		@SqlResultSetMapping(name = "stDevMapping", columns = { @ColumnResult(name = "st_dev") }),
		@SqlResultSetMapping(name = "best25PercMapping", columns = { @ColumnResult(name = "best_25_perc") }),
		@SqlResultSetMapping(name = "delta25PercAvgMapping", columns = { @ColumnResult(name = "delta_25_perc_avg") }),
		@SqlResultSetMapping(name = "nuis", classes = {
				@ConstructorResult(targetClass = Nuis.class,
			    columns = {@ColumnResult(name = "uir_id", type = Long.class),
			    		@ColumnResult(name = "ddv_id", type = Long.class),
			    		@ColumnResult(name = "nui_value", type = BigDecimal.class) }) })
})
@NamedNativeQueries(value = {
		@NamedNativeQuery(name = "VariationMeasureValue.doAllNui", resultSetMapping = "nuis", query = "WITH subq1 AS (SELECT uir.id AS user_in_role_id, uir.pilot_code AS pilot_code, vm.measure_type_id AS measure_type_id, AVG (vm.measure_value) AVG, COALESCE (STDDEV_SAMP (vm.measure_value), 0) stDev, PERCENTILE_CONT (0.25) WITHIN GROUP (ORDER BY vm.measure_value DESC) best25 FROM variation_measure_value AS vm INNER JOIN time_interval AS ti ON ti.id = vm.time_interval_id INNER JOIN user_in_role AS uir ON uir.id = vm.user_in_role_id WHERE ti.interval_start >= :startOfMonth AND ti.interval_start <= :endOfMonth GROUP BY uir. ID, vm.measure_type_id), subq2 AS (SELECT detection_variable_id, derived_detection_variable_id, pilot_code, derivation_function_formula FROM md_pilot_detection_variable) SELECT user_in_role_id as uir_id, subq2.derived_detection_variable_id as ddv_id, (CASE WHEN AVG = 0 THEN 0 WHEN subq2.derivation_function_formula LIKE '%avg%' THEN AVG WHEN subq2.derivation_function_formula LIKE '%std%' THEN stDev / AVG WHEN subq2.derivation_function_formula LIKE '%best%' THEN best25 / AVG WHEN subq2.derivation_function_formula LIKE '%delta%' THEN (best25 - AVG) / AVG END) nui_value FROM subq1, subq2 WHERE subq1.pilot_code = subq2.pilot_code AND subq1.measure_type_id = subq2.detection_variable_id AND subq2.derivation_function_formula IS NOT NULL ORDER BY subq1.user_in_role_id, subq2.derived_detection_variable_id")
})
/**
 * VariationMeasureValue generated by hbm2java
 */
@Entity
@Table(name = "variation_measure_value")
public class VariationMeasureValue extends AbstractBaseEntity<Long> {

	/**
	 * 
	 */
	private static final long serialVersionUID = 2579000073949031381L;
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "activity_id")
	private ExecutedActivity activity;
	
	@JsonView(View.VariationMeasureValueView.class)
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "measure_type_id", referencedColumnName = "id")
	private DetectionVariable detectionVariable;
	
	@JsonView(View.VariationMeasureValueView.class)
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "time_interval_id", referencedColumnName = "id")
	private TimeInterval timeInterval;
	
	
	@JsonView(View.VariationMeasureValueView.class)
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "user_in_role_id")
	private UserInRole userInRole;

	@JsonView(View.VariationMeasureValueView.class)
	@Column(name = "measure_value", precision = 30, scale = 10)
	private BigDecimal measureValue;

	@JsonView(View.VariationMeasureValueView.class)
	@Column(name = "extra_information", length = 1000)
	private String extraInformation;

	
	@Column(name = "data_source_type", length = 1000)
	private String dataSourceType;
	
	@OneToMany(mappedBy = "variationMeasureValue", fetch = FetchType.LAZY)
	private Set<SourceEvidence> sourceEvidence = new HashSet<SourceEvidence>();
	
	/*@JsonIgnore
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "measure_type_id", referencedColumnName = "detection_variable_id", insertable = false, updatable = false)
	private ViewPilotDetectionVariable vpdv;*/

	public VariationMeasureValue() {
	}

	public VariationMeasureValue(DetectionVariable detectionVariable, TimeInterval timeInterval,
			UserInRole userInRole) {
		this.detectionVariable = detectionVariable;
		this.timeInterval = timeInterval;
		this.userInRole = userInRole;
	}

	public VariationMeasureValue(ExecutedActivity activity, DetectionVariable detectionVariable, TimeInterval timeInterval,
			UserInRole userInRole, BigDecimal measureValue, String dataSourceType, String extraInformation) {
		this.activity = activity;
		this.detectionVariable = detectionVariable;
		this.timeInterval = timeInterval;
		this.userInRole = userInRole;
		this.measureValue = measureValue;
		this.dataSourceType = dataSourceType;
		this.extraInformation = extraInformation;
	}

	public ExecutedActivity getActivity() {
		return this.activity;
	}

	public void setActivity(ExecutedActivity activity) {
		this.activity = activity;
	}

	public DetectionVariable getDetectionVariable() {
		return this.detectionVariable;
	}

	public void setDetectionVariable(DetectionVariable detectionVariable) {
		this.detectionVariable = detectionVariable;
	}

	public TimeInterval getTimeInterval() {
		return this.timeInterval;
	}

	public void setTimeInterval(TimeInterval timeInterval) {
		this.timeInterval = timeInterval;
	}

	public UserInRole getUserInRole() {
		return this.userInRole;
	}

	public void setUserInRole(UserInRole userInRole) {
		this.userInRole = userInRole;
	}

	public BigDecimal getMeasureValue() {
		return this.measureValue;
	}

	public void setMeasureValue(BigDecimal measureValue) {
		this.measureValue = measureValue;
	}

	public String getDataSourceType() {
		return this.dataSourceType;
	}

	public void setDataSourceType(String dataSourceType) {
		this.dataSourceType = dataSourceType;
	}

	public String getExtraInformation() {
		return this.extraInformation;
	}

	public void setExtraInformation(String extraInformation) {
		this.extraInformation = extraInformation;
	}

	public Set<SourceEvidence> getSourceEvidence() {
		return sourceEvidence;
	}

	public void setSourceEvidence(Set<SourceEvidence> sourceEvidence) {
		this.sourceEvidence = sourceEvidence;
	}

	/*public ViewPilotDetectionVariable getVpdv() {
		return vpdv;
	}

	public void setVpdv(ViewPilotDetectionVariable vpdv) {
		this.vpdv = vpdv;
	}*/

}
